name: postgresql-postgis-db
version: 0.1.4
inherits: alexiss/ubuntu14-ruby-geo@0.1.4
type: service
platform: ubuntu@12.04
description: postgresql postgis database
keywords:
  - postgresql
  - postgis
script: |
  if [ ! -n "$WERCKER_POSTGRESQL_USERNAME" ]; then export WERCKER_POSTGRESQL_USERNAME=postgres; fi
  if [ ! -n "$WERCKER_POSTGRESQL_PASSWORD" ]; then export WERCKER_POSTGRESQL_PASSWORD=wercker; fi
  if [ ! -n "$WERCKER_POSTGRESQL_PORT" ]; then export WERCKER_POSTGRESQL_PORT=5432; fi
  if [ ! -n "$WERCKER_POSTGRESQL_DATABASE" ]; then export WERCKER_POSTGRESQL_DATABASE=werckerdb; fi
  if [ ! -n "$WERCKER_POSTGRESQL_HOST" ]; then export WERCKER_POSTGRESQL_HOST=$HOST; fi
  $WERCKER_SOURCE_DIR/create-postgis-db.sh
  sudo -- su postgres -c "psql -c 'SELECT datname FROM pg_database WHERE datistemplate=false;'"
  echo -n "Checking if database created... "
  if sudo -- su postgres -c "psql -c 'SELECT datname FROM pg_database WHERE datistemplate=false;'" | grep -Eqx "\s*${WERCKER_POSTGRESQL_DATABASE}"; then result="yes"; else result="no"; fi &> /dev/null
  echo $result
  if [ "${result}" = "no" ]; then exit 1; fi &> /dev/null
  echo -n "Checking if postgis extension created... "
  if sudo -- su postgres -c "psql -d ${WERCKER_POSTGRESQL_DATABASE} -c 'SELECT PostGIS_full_version();'" | grep -q "POSTGIS="; then result="yes"; else result="no"; exit 1; fi &> /dev/null
  echo $result
  if [ "${result}" = "no" ]; then exit 1; fi &> /dev/null
env:
  WERCKER_POSTGRESQL_USERNAME: postgres
  WERCKER_POSTGRESQL_PASSWORD: wercker
  WERCKER_POSTGRESQL_DATABASE: werckerdb
